CREATE DATABASE QuizPollApp;

CREATE TABLE User(userHash CHAR(32) PRIMARY KEY, userEmail VARCHAR(256) NOT NULL, password CHAR(60) NOT NULL, bdate DATE, username VARCHAR(100), imgUrl VARCHAR(256));

CREATE TABLE Poll(pollId INT PRIMARY KEY AUTO_INCREMENT, creatorHash CHAR(32) NOT NULL, title VARCHAR(256) NOT NULL);

ALTER TABLE Poll ADD CONSTRAINT poll_user_fk FOREIGN KEY (creatorHash) REFERENCES User(userHash) ON DELETE CASCADE ON UPDATE CASCADE;

CREATE TABLE PollOption(pollId INT, optionId INT, text VARCHAR(100) NOT NULL);

ALTER TABLE PollOption ADD CONSTRAINT polloption_poll_fk FOREIGN KEY (pollId) REFERENCES Poll(pollId) ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE PollOption ADD PRIMARY KEY (pollId, optionId);

CREATE TABLE PollVote(userHash CHAR(32), pollId INT NOT NULL, optionId INT NOT NULL, voteId INT PRIMARY KEY AUTO_INCREMENT);

ALTER TABLE PollVote ADD CONSTRAINT pollvote_user_fk FOREIGN KEY (userHash) REFERENCES User(userHash) ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE PollVote ADD CONSTRAINT pollvote_option_fk FOREIGN KEY (pollId,optionId) REFERENCES PollOption(pollId,optionId) ON DELETE CASCADE ON UPDATE CASCADE;

CREATE TABLE "Quiz"(quizId SERIAL PRIMARY KEY, creatorHash CHAR(32) NOT NULL, title VARCHAR(100) NOT NULL,score SMALLINT NOT NULL);

ALTER TABLE "Quiz" ADD CONSTRAINT quiz_user_fk FOREIGN KEY (creatorhash) REFERENCES "User"(userhash) ON DELETE CASCADE ON UPDATE CASCADE;

CREATE TABLE "QuizQuestion"(quizid INT, questionid SMALLINT, text VARCHAR(100) NOT NULL, ismcq BOOL DEFAULT false);

ALTER TABLE "QuizQuestion" ADD CONSTRAINT question_quiz_fk FOREIGN KEY (quizid) REFERENCES "Quiz"(quizid) ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE "QuizQuestion" ADD PRIMARY KEY (quizid,questionid);

CREATE TABLE "QuizOption"(quizid INT, questionid SMALLINT, optionid SMALLINT, text VARCHAR(100) NOT NULL, isans BOOL DEFAULT FALSE);

ALTER TABLE "QuizOption" ADD CONSTRAINT quizoption_question_fk FOREIGN KEY (quizid, questionid) REFERENCES "QuizQuestion" (quizid, questionid) ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE "QuizOption" ADD PRIMARY KEY (quizid, questionid, optionid);

CREATE TABLE "QuizResults"(quizId INT, userHash CHAR(32), questionId INT, optionID INT);

ALTER TABLE "QuizResults" ADD CONSTRAINT quizresult_quiz_fk FOREIGN KEY(quizId,questionId,optionId) REFERENCES "QuizOption"(quizId,questionId,optionId) ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE "QuizResults" ADD CONSTRAINT quizresult_user_fk FOREIGN KEY(userHash) REFERENCES "User"(userHash) ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE "QuizResults" ADD PRIMARY KEY (quizId,questionId,optionId,userHash);

CREATE TABLE "QuizScores"(quizid INT, userhash CHAR(32), score SMALLINT NOT NULL);

ALTER TABLE "QuizScores" ADD CONSTRAINT quizscores_quiz_fk FOREIGN KEY(quizid) REFERENCES "Quiz"(quizid) ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE "QuizScores" ADD CONSTRAINT quizscores_user_fk FOREIGN KEY(userhash) REFERENCES "User"(userhash) ON DELETE CASCADE ON UPDATE CASCADE;

ALTER TABLE "QuizScores" ADD PRIMARY KEY(quizid,userhash);

